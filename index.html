<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown åŒå±ç¼–è¾‘å™¨</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      line-height: 1.6;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    header {
      flex-shrink: 0;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    h1 {
      color: #333;
      margin: 0 0 4px 0;
      font-size: 20px;
    }
    
    .description {
      color: #666;
      font-size: 13px;
      margin: 0;
    }
    
    .help-btn {
      padding: 8px 16px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
      color: #555;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .help-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }
    
    .help-btn::before {
      content: "?";
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: #999;
      color: white;
      border-radius: 50%;
      font-size: 11px;
      font-weight: bold;
    }
    
    /* å¼¹çª—å®¹å™¨ */
    .modal-overlay {
      display: none;
      position: absolute;
      top: 48px;
      right: 16px;
      z-index: 1000;
    }
    
    .modal-overlay.active {
      display: block;
    }
    
    /* å¼¹çª— */
    .modal {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      width: 320px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }
    
    .modal-header {
      padding: 14px 16px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    
    .modal-close {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      color: #999;
      font-size: 18px;
      line-height: 1;
      padding: 0;
    }
    
    .modal-close:hover {
      background: #e0e0e0;
      color: #666;
    }
    
    .modal-body {
      padding: 12px 16px;
    }
    
    .syntax-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .syntax-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .syntax-item:last-child {
      border-bottom: none;
    }
    
    .syntax-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .syntax-name {
      flex: 1;
      font-size: 13px;
      color: #333;
    }
    
    .syntax-code {
      font-family: "SF Mono", Monaco, "Cascadia Code", Consolas, monospace;
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .editor-wrapper {
      flex: 1;
      display: flex;
      gap: 12px;
      min-height: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .editor-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }
    
    .editor-pane:first-child {
      border-right: 1px solid #e0e0e0;
    }
    
    .pane-header {
      padding: 10px 16px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .pane-header::before {
      content: "";
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }
    
    .editor-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    /* Markdown æ–‡æœ¬æ¡†æ ·å¼ */
    .editor-container textarea {
      width: 100%;
      height: 100%;
      padding: 16px;
      border: none;
      outline: none;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
      font-size: 14px;
      line-height: 1.7;
      resize: none;
      background: #fff;
      overflow-y: auto;
    }
    
    /* ProseMirror ç¼–è¾‘å™¨æ ·å¼ */
    .ProseMirror {
      position: relative;
      height: 100%;
      padding: 16px;
      outline: none;
      overflow-y: auto;
      word-wrap: break-word;
      white-space: pre-wrap;
      white-space: break-spaces;
      -webkit-font-variant-ligatures: none;
      font-variant-ligatures: none;
      font-feature-settings: "liga" 0;
    }
    
    .ProseMirror p {
      margin: 0 0 1em 0;
    }
    
    .ProseMirror h1, 
    .ProseMirror h2, 
    .ProseMirror h3, 
    .ProseMirror h4 {
      margin: 1.2em 0 0.5em 0;
      line-height: 1.3;
    }
    
    .ProseMirror h1 { font-size: 1.8em; }
    .ProseMirror h2 { font-size: 1.5em; }
    .ProseMirror h3 { font-size: 1.25em; }
    
    .ProseMirror ul, 
    .ProseMirror ol {
      padding-left: 2em;
      margin: 0 0 1em 0;
    }
    
    .ProseMirror blockquote {
      border-left: 3px solid #ddd;
      padding-left: 1em;
      margin: 0 0 1em 0;
      color: #666;
    }
    
    .ProseMirror pre {
      background: #f4f4f4;
      padding: 1em;
      border-radius: 4px;
      overflow-x: auto;
    }
    
    .ProseMirror code {
      background: #f4f4f4;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: monospace;
      font-size: 0.9em;
    }
    
    .ProseMirror pre code {
      background: none;
      padding: 0;
    }
    
    .ProseMirror a {
      color: #0066cc;
      text-decoration: none;
    }
    
    .ProseMirror a:hover {
      text-decoration: underline;
    }
    
    .ProseMirror hr {
      border: none;
      border-top: 2px solid #ddd;
      margin: 2em 0;
    }
    
    .ProseMirror img {
      max-width: 100%;
      height: auto;
    }
    
    .ProseMirror table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    
    .ProseMirror td, 
    .ProseMirror th {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: left;
    }
    
    .ProseMirror th {
      background: #f5f5f5;
    }
    
    /* ProseMirror èœå•æ ·å¼ */
    .ProseMirror-menubar {
      border-bottom: 1px solid #e0e0e0;
      padding: 5px 10px;
      background: #fafafa;
      flex-shrink: 0;
    }
    
    .ProseMirror-menubar-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .ProseMirror-menubar-wrapper > .ProseMirror {
      flex: 1;
      overflow-y: auto;
    }
    
    .ProseMirror-menubar-wrapper .ProseMirror {
      padding-top: 10px;
    }
    
    .ProseMirror-menuitem {
      display: inline-block;
      margin-right: 3px;
    }
    
    .ProseMirror-menuseparator {
      display: inline-block;
      margin: 0 4px;
      border-right: 1px solid #ddd;
      height: 20px;
      vertical-align: middle;
    }
    
    .ProseMirror-icon {
      display: inline-block;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
    }
    
    .ProseMirror-icon:hover {
      background: #e0e0e0;
    }
    
    .ProseMirror-icon svg {
      fill: currentColor;
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }
    
    .ProseMirror-menu-active {
      background: #ddd;
    }
    
    .ProseMirror-prompt {
      position: absolute;
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
    }
    
    .ProseMirror-prompt input[type="text"] {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 8px;
      width: 250px;
    }
    
    .ProseMirror-prompt-buttons {
      margin-top: 10px;
      text-align: right;
    }
    
    .ProseMirror-prompt-buttons button {
      padding: 6px 16px;
      margin-left: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .ProseMirror-prompt-buttons button[type="submit"] {
      background: #0066cc;
      color: white;
    }
    
    .ProseMirror-prompt-buttons button[type="button"] {
      background: #e0e0e0;
      color: #333;
    }
    
    /* é€‰ä¸­æ ·å¼ */
    .ProseMirror-selectednode {
      outline: 2px solid #8cf;
    }
    
    .ProseMirror ::selection {
      background: #b3d4fc;
    }
    
    /* GapCursor */
    .ProseMirror-gapcursor {
      display: none;
      pointer-events: none;
      position: absolute;
    }
    
    .ProseMirror-gapcursor:after {
      content: "";
      display: block;
      position: absolute;
      top: -2px;
      width: 20px;
      border-top: 1px solid black;
      animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
    }
    
    @keyframes ProseMirror-cursor-blink {
      to { visibility: hidden; }
    }
    
    .ProseMirror-focused .ProseMirror-gapcursor {
      display: block;
    }
    
    /* Drop cursor */
    .ProseMirror-dropcursor {
      background: #666;
      width: 2px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ğŸ“ Markdown åŒå±ç¼–è¾‘å™¨</h1>
      <p class="description">å·¦ä¾§ç¼–è¾‘ Markdown æºç ï¼Œå³ä¾§å®æ—¶é¢„è§ˆã€‚ä¸¤ä¾§å†…å®¹ä¼šè‡ªåŠ¨åŒæ­¥ã€‚</p>
    </div>
    <button class="help-btn" id="helpBtn">è¯­æ³•å¸®åŠ©</button>
  </header>

  <!-- è¯­æ³•å¸®åŠ©å¼¹çª— -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">è¯­æ³•å¸®åŠ©</span>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <ul class="syntax-list">
          <li class="syntax-item">
            <span class="syntax-icon"><b>H1</b></span>
            <span class="syntax-name">ä¸€çº§æ ‡é¢˜</span>
            <code class="syntax-code"># + ç©ºæ ¼</code>
          </li>
          <li class="syntax-item">
            <span class="syntax-icon"><b>H2</b></span>
            <span class="syntax-name">äºŒçº§æ ‡é¢˜</span>
            <code class="syntax-code">## + ç©ºæ ¼</code>
          </li>
          <li class="syntax-item">
            <span class="syntax-icon">&ldquo;</span>
            <span class="syntax-name">å¼•ç”¨å—</span>
            <code class="syntax-code">&gt; + ç©ºæ ¼</code>
          </li>
          <li class="syntax-item">
            <span class="syntax-icon">â˜°</span>
            <span class="syntax-name">æœ‰åºåˆ—è¡¨</span>
            <code class="syntax-code">æ•°å­— + . + ç©ºæ ¼</code>
          </li>
          <li class="syntax-item">
            <span class="syntax-icon">â˜°</span>
            <span class="syntax-name">æ— åºåˆ—è¡¨</span>
            <code class="syntax-code">- + ç©ºæ ¼</code>
          </li>
          <li class="syntax-item">
            <span class="syntax-icon"><b>B</b></span>
            <span class="syntax-name">ç²—ä½“</span>
            <code class="syntax-code">**æ–‡å­—** + ç©ºæ ¼</code>
          </li>
        </ul>
      </div>
    </div>
  </div>
  
  <div class="editor-wrapper">
    <!-- å·¦ä¾§ï¼šMarkdown æºç  -->
    <div class="editor-pane">
      <div class="pane-header">Markdown æºç </div>
      <div id="markdown-editor" class="editor-container"></div>
    </div>
    
    <!-- å³ä¾§ï¼šå¯è§†ç¼–è¾‘ -->
    <div class="editor-pane">
      <div class="pane-header">å¯è§†ç¼–è¾‘</div>
      <div id="wysiwyg-editor" class="editor-container"></div>
    </div>
  </div>

  <!-- Import Map -->
  <script type="importmap">
  {
    "imports": {
      "prosemirror-view": "./node_modules/prosemirror-view/dist/index.js",
      "prosemirror-state": "./node_modules/prosemirror-state/dist/index.js",
      "prosemirror-markdown": "./node_modules/prosemirror-markdown/dist/index.js",
      "prosemirror-example-setup": "./node_modules/prosemirror-example-setup/dist/index.js",
      "prosemirror-model": "./node_modules/prosemirror-model/dist/index.js",
      "prosemirror-transform": "./node_modules/prosemirror-transform/dist/index.js",
      "prosemirror-commands": "./node_modules/prosemirror-commands/dist/index.js",
      "prosemirror-keymap": "./node_modules/prosemirror-keymap/dist/index.js",
      "prosemirror-schema-list": "./node_modules/prosemirror-schema-list/dist/index.js",
      "prosemirror-history": "./node_modules/prosemirror-history/dist/index.js",
      "prosemirror-dropcursor": "./node_modules/prosemirror-dropcursor/dist/index.js",
      "prosemirror-gapcursor": "./node_modules/prosemirror-gapcursor/dist/index.js",
      "prosemirror-menu": "./node_modules/prosemirror-menu/dist/index.js",
      "prosemirror-inputrules": "./node_modules/prosemirror-inputrules/dist/index.js",
      "crelt": "./node_modules/crelt/index.js",
      "orderedmap": "./node_modules/orderedmap/dist/index.js",
      "rope-sequence": "./node_modules/rope-sequence/dist/index.js",
      "w3c-keyname": "./node_modules/w3c-keyname/index.js",
      "markdown-it": "./node_modules/markdown-it/index.mjs",
      "entities": "./node_modules/entities/lib/esm/index.js",
      "linkify-it": "./node_modules/linkify-it/index.mjs",
      "mdurl": "./node_modules/mdurl/index.mjs",
      "punycode.js": "./node_modules/punycode.js/punycode.es6.js",
      "uc.micro": "./node_modules/uc.micro/index.mjs"
    }
  }
  </script>

  <script type="module">
    import { EditorView } from 'prosemirror-view';
    import { EditorState } from 'prosemirror-state';
    import { schema, defaultMarkdownParser, defaultMarkdownSerializer } from 'prosemirror-markdown';
    import { exampleSetup } from 'prosemirror-example-setup';

    // é»˜è®¤å†…å®¹
    const defaultContent = `## æ¬¢è¿ä½¿ç”¨ Markdown åŒå±ç¼–è¾‘å™¨

å·¦ä¾§æ˜¯ **Markdown æºç **ï¼Œå³ä¾§æ˜¯ **å®æ—¶é¢„è§ˆ**ã€‚

### ç‰¹æ€§

- ä¸¤ä¾§å†…å®¹å®æ—¶åŒæ­¥
- æ”¯æŒå¸¸ç”¨ Markdown è¯­æ³•
- å¯è§†åŒ–å·¥å…·æ æ“ä½œ

### ç¤ºä¾‹

**ç²—ä½“**ã€*æ–œä½“*ã€\`ä»£ç \`

\`\`\`javascript
function hello() {
  console.log("Hello World!");
}
\`\`\`

> å¼•ç”¨å—

| åŠŸèƒ½ | çŠ¶æ€ |
|------|------|
| å®æ—¶åŒæ­¥ | âœ… |
| åŒå±ç¼–è¾‘ | âœ… |

---

å¼€å§‹ç¼–è¾‘å§ï¼`;

    // Markdown è§†å›¾
    class MarkdownView {
      constructor(target, content, onChange) {
        this.textarea = document.createElement("textarea");
        this.textarea.value = content;
        this.textarea.spellcheck = false;
        target.appendChild(this.textarea);
        
        this.onChange = onChange;
        this.debounceTimer = null;
        
        this.textarea.addEventListener('input', () => {
          clearTimeout(this.debounceTimer);
          this.debounceTimer = setTimeout(() => {
            this.onChange(this.textarea.value);
          }, 300);
        });
      }

      get content() {
        return this.textarea.value;
      }

      setContent(content) {
        if (this.textarea.value !== content) {
          const start = this.textarea.selectionStart;
          const end = this.textarea.selectionEnd;
          this.textarea.value = content;
          this.textarea.setSelectionRange(start, end);
        }
      }

      focus() {
        this.textarea.focus();
      }

      destroy() {
        this.textarea.remove();
      }
    }

    // ProseMirror è§†å›¾
    class ProseMirrorView {
      constructor(target, content, onChange) {
        this.onChange = onChange;
        this.debounceTimer = null;
        
        let doc;
        try {
          doc = defaultMarkdownParser.parse(content);
        } catch (e) {
          console.warn('Markdown è§£æå¤±è´¥:', e);
        }
        if (!doc) {
          doc = schema.node("doc", null, [schema.node("paragraph")]);
        }
        
        this.view = new EditorView(target, {
          state: EditorState.create({
            doc: doc,
            plugins: exampleSetup({ schema, menuBar: true })
          }),
          dispatchTransaction: (tr) => {
            const newState = this.view.state.apply(tr);
            this.view.updateState(newState);
            
            if (tr.docChanged) {
              clearTimeout(this.debounceTimer);
              this.debounceTimer = setTimeout(() => {
                this.onChange(this.content);
              }, 300);
            }
          }
        });
      }

      get content() {
        return defaultMarkdownSerializer.serialize(this.view.state.doc);
      }

      setContent(content) {
        const currentContent = this.content;
        if (currentContent !== content) {
          let newDoc;
          try {
            newDoc = defaultMarkdownParser.parse(content);
          } catch (e) {
            console.warn('Markdown è§£æå¤±è´¥:', e);
          }
          if (newDoc) {
            const tr = this.view.state.tr.replaceWith(0, this.view.state.doc.content.size, newDoc.content);
            this.view.dispatch(tr);
          }
        }
      }

      focus() {
        this.view.focus();
      }

      destroy() {
        this.view.destroy();
      }
    }

    // è¯­æ³•å¸®åŠ©å¼¹çª—
    const helpBtn = document.getElementById('helpBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    
    helpBtn.addEventListener('click', () => {
      modalOverlay.classList.add('active');
    });
    
    modalClose.addEventListener('click', () => {
      modalOverlay.classList.remove('active');
    });
    
    // åˆå§‹åŒ–
    const mdTarget = document.querySelector("#markdown-editor");
    const pmTarget = document.querySelector("#wysiwyg-editor");
    
    let isSyncing = false;
    
    const mdView = new MarkdownView(mdTarget, defaultContent, (content) => {
      if (!isSyncing) {
        isSyncing = true;
        pmView.setContent(content);
        isSyncing = false;
      }
    });
    
    const pmView = new ProseMirrorView(pmTarget, defaultContent, (content) => {
      if (!isSyncing) {
        isSyncing = true;
        mdView.setContent(content);
        isSyncing = false;
      }
    });
  </script>
</body>
</html>
